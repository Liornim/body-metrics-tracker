<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 转拽 - 转 </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .explanation {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .explanation h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .explanation p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .formula {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: right;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid #2e7d32;
        }
        
        td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody tr:hover {
            background: #f5f5f5;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .value-positive {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .value-negative {
            color: #f44336;
            font-weight: bold;
        }
        
        .value-neutral {
            font-weight: bold;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        @media (max-width: 768px) {
            .table-container {
                overflow-x: scroll;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> 转 转拽 - 转 </h1>
            <p>砖 转拽 转转 转  砖 5, 7, 10, 14, 21 -28 </p>
        </div>
        
        <div class="content">
            <div class="explanation">
                <h4>   注?</h4>
                <p><strong>住:</strong> 转拽 转转 = 拽专转 爪注转 + (专转 砖拽  7700 梅 ) - (爪注 爪注 梅 25)</p>
                <div class="formula">
                    Real Maintenance = Avg Calories + (Weight Loss  7700 梅 Days) - (Avg Steps 梅 25)
                </div>
                <p><strong>7700 拽专转 = 1 拽" 砖</strong> -  专 拽转 专转 砖拽</p>
                <p><strong>25 爪注 = 1 拽专</strong> -  专 爪注 砖砖专驻</p>
            </div>
            
            <button class="export-btn" onclick="exportToExcel()"> 爪 -Excel</button>
            
            <div id="loading" class="loading" style="display: none;">
                 注 转 砖 转拽...
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="tablesContainer"></div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxm9p0ckreQ88HAqR-DZ_blJqyEhtm2GCQy_gXtvHyjXZULMdMgdWWFaIaFXfT-4ZT6/exec';
        
        const windowSizes = [5, 7, 10, 14, 21, 28];
        let calculatedData = {}; // Store data for each window size
        
        // Parse DD/MM/YYYY date format
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        // Format date as DD/MM/YYYY
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Subtract one day from a date
        function subtractOneDay(dateStr) {
            const date = parseDate(dateStr);
            if (!date) return null;
            date.setDate(date.getDate() - 1);
            return formatDate(date);
        }
        
        // Sort data by date ascending
        function sortDataAsc(data) {
            return [...data].sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                if (!dateA || !dateB) return 0;
                return dateA - dateB;
            });
        }
        
        // Create non-overlapping chunks (same logic as weight-summary-tdee-without-steps.html)
        function createChunks(data, windowSize) {
            const chunks = [];
            for (let i = 0; i < data.length; i += windowSize) {
                chunks.push(data.slice(i, i + windowSize));
            }
            return chunks;
        }
        
        // Calculate mean
        function calculateMean(values) {
            if (values.length === 0) return 0;
            const validValues = values.filter(v => v !== null && v !== undefined && !isNaN(v));
            if (validValues.length === 0) return 0;
            return validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
        }
        
        // Process window analysis for weight data (same logic as weight-summary-tdee-without-steps.html)
        function processWindowAnalysis(data, windowSize) {
            const sortedData = sortDataAsc(data);
            const chunks = createChunks(sortedData, windowSize);
            
            const results = [];
            
            chunks.forEach((chunk, index) => {
                if (chunk.length === 0) return;
                
                // Only include full windows (exactly windowSize days)
                if (chunk.length !== windowSize) return;
                
                const weights = chunk.map(item => item.weight);
                const average = calculateMean(weights);
                const dateRange = `${chunk[0].date} - ${chunk[chunk.length - 1].date}`;
                
                const result = {
                    window: windowSize,
                    range: dateRange,
                    average: average,
                    delta: null,
                    index: index + 1,
                    daysCount: chunk.length,
                    startDate: chunk[0].date,
                    endDate: chunk[chunk.length - 1].date
                };
                
                // Calculate delta vs previous window
                if (index > 0) {
                    // Find the previous full window
                    for (let prevIndex = index - 1; prevIndex >= 0; prevIndex--) {
                        if (chunks[prevIndex].length === windowSize) {
                            const prevWeights = chunks[prevIndex].map(item => item.weight);
                            const prevAverage = calculateMean(prevWeights);
                            result.delta = average - prevAverage;
                            break;
                        }
                    }
                }
                
                results.push(result);
            });
            
            return results;
        }
        
        // Get nutrition data for a date range (calories dates are -1 day from weight dates)
        function getNutritionForWindow(nutritionData, startDate, endDate) {
            // Calculate calories dates (weight dates - 1 day)
            const caloriesStartDate = subtractOneDay(startDate);
            const caloriesEndDate = subtractOneDay(endDate);
            
            if (!caloriesStartDate || !caloriesEndDate) {
                return { avgCalories: 0, totalCalories: 0, avgSteps: 0, caloriesRange: '--' };
            }
            
            // Check if first row is header
            const hasHeader = nutritionData[0] && nutritionData[0][0] && 
                             (typeof nutritionData[0][0] === 'string') && 
                             (nutritionData[0][0].includes('转专') || nutritionData[0][0].includes('Date'));
            
            const dataStartIndex = hasHeader ? 1 : 0;
            
            // Data is ordered from newest to oldest, so we need to find matching dates
            const calories = [];
            const steps = [];
            
            for (let i = dataStartIndex; i < nutritionData.length; i++) {
                const row = nutritionData[i];
                if (!row || row.length === 0) continue;
                
                const rowDate = row[0];
                if (!rowDate) continue;
                
                // Check if date is within range (inclusive)
                const date = parseDate(rowDate);
                const start = parseDate(caloriesStartDate);
                const end = parseDate(caloriesEndDate);
                
                if (!date || !start || !end) continue;
                
                // Compare dates (accounting for order - data might be newest to oldest)
                const isInRange = (date >= start && date <= end) || (date >= end && date <= start);
                
                if (isInRange) {
                    const cal = parseFloat(row[1]) || 0; // Calories in column 1
                    const step = parseFloat(row[6]) || 0; // Steps in column 6
                    
                    if (cal > 0) calories.push(cal);
                    if (step > 0) steps.push(step);
                }
            }
            
            const avgCalories = calculateMean(calories);
            const totalCalories = calories.reduce((sum, cal) => sum + cal, 0);
            const avgSteps = calculateMean(steps);
            
            return {
                avgCalories: avgCalories,
                totalCalories: totalCalories,
                avgSteps: avgSteps,
                caloriesRange: `${caloriesStartDate} - ${caloriesEndDate}`
            };
        }
        
        // Load data and calculate on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('tablesContainer').innerHTML = '';
                
                // Load both body metrics and nutrition data
                const [bodyMetricsResponse, nutritionResponse] = await Promise.all([
                    fetch(`${GOOGLE_SCRIPT_URL}?action=get`),
                    fetch(`${GOOGLE_SCRIPT_URL}?action=getNutrition`)
                ]);
                
                const bodyMetricsData = await bodyMetricsResponse.json();
                const nutritionData = await nutritionResponse.json();
                
                if (!bodyMetricsData.success || !nutritionData.success) {
                    showError('砖 注转 转');
                    return;
                }
                
                // Check if first row is header for weight data
                const hasHeader = bodyMetricsData.data[0] && bodyMetricsData.data[0][0] && 
                                 (typeof bodyMetricsData.data[0][0] === 'string') && 
                                 (bodyMetricsData.data[0][0].includes('转专') || bodyMetricsData.data[0][0].includes('Date') || 
                                  bodyMetricsData.data[0][0].includes('砖拽') || bodyMetricsData.data[0][0].includes('Weight'));
                
                const startIndex = hasHeader ? 1 : 0;
                
                // Convert weight data to the format we need
                // Data is ordered from newest to oldest, so we need to reverse it
                const rawWeightData = bodyMetricsData.data.slice(startIndex).reverse();
                
                const weightData = rawWeightData.map(row => ({
                    date: row[0],
                    weight: parseFloat(row[1]) || 0
                })).filter(item => item.weight > 0 && item.date);
                
                // Calculate maintenance for each window size
                calculatedData = {};
                
                windowSizes.forEach(windowSize => {
                    const results = processWindowAnalysis(weightData, windowSize);
                    const maintenanceResults = [];
                    
                    results.forEach((result, index) => {
                        // Get previous window for comparison
                        const previousResult = index > 0 ? results[index - 1] : null;
                        
                        if (!previousResult) {
                            // First window - no comparison
                            return;
                        }
                        
                        // Get nutrition data for current window
                        const nutrition = getNutritionForWindow(nutritionData.data, result.startDate, result.endDate);
                        
                        // Calculate weight loss (positive = loss, negative = gain)
                        const weightLoss = previousResult.average - result.average;
                        
                        // Calculate real maintenance
                        const weightLossCalories = (weightLoss * 7700) / windowSize; // Daily calorie deficit from weight loss
                        const stepsCalories = nutrition.avgSteps / 25; // Calories burned from steps
                        const realMaintenance = nutrition.avgCalories + weightLossCalories - stepsCalories;
                        
                        maintenanceResults.push({
                            windowNumber: result.index,
                            dateRange: result.range,
                            currentAvgWeight: result.average.toFixed(2),
                            previousAvgWeight: previousResult.average.toFixed(2),
                            weightLoss: weightLoss.toFixed(2),
                            currentAvgCalories: nutrition.avgCalories.toFixed(0),
                            currentAvgSteps: nutrition.avgSteps.toFixed(0),
                            weightLossCalories: weightLossCalories.toFixed(0),
                            stepsCalories: stepsCalories.toFixed(0),
                            realMaintenance: realMaintenance.toFixed(0)
                        });
                    });
                    
                    calculatedData[windowSize] = maintenanceResults;
                });
                
                displayTables();
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('砖 专 砖专转: ' + error.message);
            }
        }
        
        function displayTables() {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';
            
            windowSizes.forEach(windowSize => {
                const data = calculatedData[windowSize] || [];
                
                if (data.length === 0) return;
                
                // Show only last 5 windows
                const displayData = data.slice(-5);
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.style.marginTop = '40px';
                
                const title = document.createElement('h2');
                title.style.marginBottom = '20px';
                title.style.color = '#2e7d32';
                title.style.textAlign = 'center';
                title.textContent = ` 转 砖 ${windowSize} `;
                tableContainer.appendChild(title);
                
                const table = document.createElement('table');
                table.id = `maintenanceTable${windowSize}`;
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th></th>
                        <th>转拽驻</th>
                        <th>砖拽 爪注 ()</th>
                        <th>砖拽 爪注 (拽)</th>
                        <th>砖 砖拽</th>
                        <th>拽专转 爪注转</th>
                        <th>爪注 爪注</th>
                        <th>拽专转 专转 砖拽</th>
                        <th>拽专转 爪注</th>
                        <th>转拽 转转</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                tbody.id = `tableBody${windowSize}`;
                
                displayData.forEach(result => {
                    const row = document.createElement('tr');
                    
                    const weightLossClass = parseFloat(result.weightLoss) > 0 ? 'value-positive' : 'value-negative';
                    const weightLossCaloriesClass = parseFloat(result.weightLossCalories) > 0 ? 'value-positive' : 'value-negative';
                    
                    row.innerHTML = `
                        <td><strong>${result.windowNumber}</strong></td>
                        <td>${result.dateRange}</td>
                        <td>${result.currentAvgWeight} 拽"</td>
                        <td>${result.previousAvgWeight} 拽"</td>
                        <td class="${weightLossClass}">
                            ${parseFloat(result.weightLoss) > 0 ? '+' : ''}${result.weightLoss} 拽"
                            ${parseFloat(result.weightLoss) > 0 ? '(专)' : '(注)'}
                        </td>
                        <td>${result.currentAvgCalories}</td>
                        <td>${result.currentAvgSteps}</td>
                        <td class="${weightLossCaloriesClass}">
                            ${parseFloat(result.weightLossCalories) > 0 ? '+' : ''}${result.weightLossCalories}
                            ${parseFloat(result.weightLossCalories) > 0 ? '(住驻)' : '(驻转)'}
                        </td>
                        <td class="value-negative">-${result.stepsCalories}</td>
                        <td class="value-neutral" style="font-size: 16px; color: #2e7d32;">
                            ${result.realMaintenance} 拽专转
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                container.appendChild(tableContainer);
            });
        }
        
        function exportToExcel() {
            let hasData = false;
            Object.values(calculatedData).forEach(data => {
                if (data.length > 0) hasData = true;
            });
            
            if (!hasData) {
                alert(' 转 爪');
                return;
            }
            
            // Create CSV content
            const headers = [
                '',
                '转拽驻',
                '砖拽 爪注 ()',
                '砖拽 爪注 (拽)',
                '砖 砖拽',
                '拽专转 爪注转',
                '爪注 爪注',
                '拽专转 专转 砖拽',
                '拽专转 爪注',
                '转拽 转转'
            ];
            
            let csvContent = '';
            
            windowSizes.forEach(windowSize => {
                const data = calculatedData[windowSize] || [];
                if (data.length === 0) return;
                
                csvContent += `转 砖 ${windowSize} \n`;
                csvContent += headers.map(h => {
                    const escaped = h.replace(/"/g, '""');
                    return `"${escaped}"`;
                }).join(',') + '\n';
                
                data.forEach(result => {
                    const weightLoss = parseFloat(result.weightLoss) > 0 ? `+${result.weightLoss} 拽" (专)` : `${result.weightLoss} 拽" (注)`;
                    const weightLossCalories = parseFloat(result.weightLossCalories) > 0 ? `+${result.weightLossCalories} (住驻)` : `${result.weightLossCalories} (驻转)`;
                    const stepsCalories = `-${result.stepsCalories}`;
                    const realMaintenance = `${result.realMaintenance} 拽专转`;
                    
                    const row = [
                        result.windowNumber,
                        result.dateRange,
                        `${result.currentAvgWeight} 拽"`,
                        `${result.previousAvgWeight} 拽"`,
                        weightLoss,
                        result.currentAvgCalories,
                        result.currentAvgSteps,
                        weightLossCalories,
                        stepsCalories,
                        realMaintenance
                    ];
                    
                    csvContent += row.map(cell => {
                        let cellText = String(cell);
                        if (cellText.startsWith('=') || cellText.startsWith('+') || cellText.startsWith('-')) {
                            cellText = ' ' + cellText;
                        }
                        const escaped = cellText.replace(/"/g, '""');
                        return `"${escaped}"`;
                    }).join(',') + '\n';
                });
                
                csvContent += '\n';
            });
            
            // Create and download file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `转拽_转__${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
        }
    </script>
</body>
</html>
