<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סקירה מקיפה - ניתוח ממוצעי חלונות</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .summary h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .windows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .window-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .window-card:hover {
            transform: translateY(-5px);
        }
        
        .window-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .window-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .window-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .window-item.positive {
            border-left-color: #4CAF50;
        }
        
        .window-item.negative {
            border-left-color: #f44336;
        }
        
        .window-item.neutral {
            border-left-color: #ff9800;
        }
        
        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .window-number {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .window-dates {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .window-days {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .window-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .window-average {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        
        .window-delta {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .window-delta.positive {
            background: #ffebee;
            color: #f44336;
        }
        
        .window-delta.negative {
            background: #e8f5e8;
            color: #4CAF50;
        }
        
        .window-delta.neutral {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .trend-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 1.2rem;
        }
        
        .trend-up { color: #f44336; }  /* Red for weight gain (bad) */
        .trend-down { color: #4CAF50; }  /* Green for weight loss (good) */
        .trend-stable { color: #ff9800; }
        
        .window-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }
        
        .summary-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .summary-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>סיכום משקל לפי חלונות</h1>
            <p>סקירה מקיפה של התקדמות המשקל בכל חלונות הזמן</p>
        </div>
        
        <div class="content">
            <div class="controls">
                <button class="refresh-btn" onclick="loadData()">🔄 רענן נתונים</button>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                טוען נתונים ומחשב ניתוחים...
            </div>
            
            <div id="summary" class="summary" style="display: none;">
                <h3>📈 סיכום התקדמות</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDays">0</div>
                        <div class="stat-label">ימים במעקב</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="weightLoss">0.0</div>
                        <div class="stat-label">ירידה במשקל (ק״ג)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="bestWindow">-</div>
                        <div class="stat-label">החלון הטוב ביותר</div>
                    </div>
                </div>
            </div>
            
            <div id="results" class="results">
                <div class="no-data">
                    לחץ על "רענן נתונים" כדי לטעון את הנתונים
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        const windowSizes = [3, 5, 7, 9, 14];
        
        // Parse DD/MM/YYYY date format
        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        // Sort data by date ascending
        function sortDataAsc(data) {
            return [...data].sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);
                return dateA - dateB;
            });
        }
        
        // Create non-overlapping chunks
        function createChunks(data, windowSize) {
            const chunks = [];
            for (let i = 0; i < data.length; i += windowSize) {
                chunks.push(data.slice(i, i + windowSize));
            }
            return chunks;
        }
        
        // Calculate mean
        function calculateMean(weights) {
            if (weights.length === 0) return 0;
            return weights.reduce((sum, weight) => sum + weight, 0) / weights.length;
        }
        
        // Format weight with 2 decimal places
        function formatWeight(weight) {
            return weight.toFixed(2);
        }
        
        // Format delta with sign
        function formatDelta(delta) {
            if (delta === null) return '—';
            const sign = delta >= 0 ? '+' : '';
            return `${sign}${delta.toFixed(2)}`;
        }
        
        // Get trend indicator
        function getTrendIndicator(delta) {
            if (delta === null) return '';
            if (delta > 0) return '<span class="trend-indicator trend-up">↗</span>';  // Weight gain = red arrow up (bad)
            if (delta < 0) return '<span class="trend-indicator trend-down">↘</span>';  // Weight loss = green arrow down (good)
            return '<span class="trend-indicator trend-stable">→</span>';
        }
        
        // Calculate summary for available windows (up to 4, or all if less than 4)
        function calculateWindowSummary(results) {
            if (results.length === 0) return null;
            
            // Take up to 4 windows, or all if less than 4
            const windowsToShow = Math.min(4, results.length);
            const lastWindows = results.slice(-windowsToShow);
            const averages = lastWindows.map(r => r.average);
            const deltas = lastWindows.filter(r => r.delta !== null).map(r => r.delta);
            
            const avgWeight = calculateMean(averages);
            const avgDelta = deltas.length > 0 ? calculateMean(deltas) : 0;
            const totalDays = lastWindows.reduce((sum, r) => sum + r.daysCount, 0);
            
            // Calculate average change per day
            const avgChangePerDay = totalDays > 0 ? (avgDelta / (lastWindows[0].window || 1)) : 0;
            
            // Calculate total change from first to last window
            const totalChange = lastWindows.length > 1 ? 
                lastWindows[lastWindows.length - 1].average - lastWindows[0].average : 0;
            
            // Debug logging
            console.log('Window Summary Debug:', {
                windowsToShow: windowsToShow,
                lastWindows: lastWindows.map(r => ({ daysCount: r.daysCount, range: r.range })),
                totalDays: totalDays,
                avgChangePerDay: avgChangePerDay,
                totalChange: totalChange
            });
            
            return {
                avgWeight: avgWeight,
                avgDelta: avgDelta,
                avgChangePerDay: avgChangePerDay,
                totalChange: totalChange,
                totalDays: totalDays,
                windowCount: windowsToShow
            };
        }
        
        // Get delta class for styling (inverted for weight: minus=good=green, plus=bad=red)
        function getDeltaClass(delta) {
            if (delta === null) return 'neutral';
            return delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral';
        }
        
        // Process window analysis
        function processWindowAnalysis(data, windowSize) {
            const sortedData = sortDataAsc(data);
            const chunks = createChunks(sortedData, windowSize);
            
            const results = [];
            
            chunks.forEach((chunk, index) => {
                if (chunk.length === 0) return;
                
                const weights = chunk.map(item => item.weight);
                const average = calculateMean(weights);
                const dateRange = `${chunk[0].date} - ${chunk[chunk.length - 1].date}`;
                
                const result = {
                    window: windowSize,
                    range: dateRange,
                    average: average,
                    delta: null,
                    index: index + 1,
                    daysCount: chunk.length
                };
                
                // Debug logging for each window
                console.log(`Window ${windowSize} - Chunk ${index + 1}:`, {
                    chunkLength: chunk.length,
                    dateRange: dateRange,
                    daysCount: result.daysCount
                });
                
                // Calculate delta vs previous window
                if (index > 0) {
                    result.delta = average - results[index - 1].average;
                }
                
                results.push(result);
            });
            
            return results;
        }
        
        // Calculate summary statistics
        function calculateSummary(data) {
            if (data.length === 0) return null;
            
            const sortedData = sortDataAsc(data);
            const totalDays = sortedData.length;
            const weightLoss = sortedData[0].weight - sortedData[sortedData.length - 1].weight;
            
            // Find best performing window
            let bestWindow = null;
            let bestPerformance = 0;
            
            windowSizes.forEach(size => {
                const results = processWindowAnalysis(data, size);
                if (results.length >= 2) {
                    const lastDelta = results[results.length - 1].delta;
                    if (lastDelta !== null && lastDelta < bestPerformance) {
                        bestPerformance = lastDelta;
                        bestWindow = size;
                    }
                }
            });
            
            return {
                totalDays,
                weightLoss: Math.max(0, weightLoss),
                bestWindow: bestWindow ? `${bestWindow} ימים` : '-'
            };
        }
        
        // Display summary
        function displaySummary(summary) {
            if (!summary) return;
            
            document.getElementById('totalDays').textContent = summary.totalDays;
            document.getElementById('weightLoss').textContent = summary.weightLoss.toFixed(1);
            document.getElementById('bestWindow').textContent = summary.bestWindow;
            document.getElementById('summary').style.display = 'block';
        }
        
        // Display results
        function displayResults(data) {
            const container = document.getElementById('results');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-data">אין נתונים מספיקים לניתוח</div>';
                return;
            }
            
            let html = '<div class="windows-grid">';
            
            windowSizes.forEach(windowSize => {
                const results = processWindowAnalysis(data, windowSize);
                const lastFourWindows = results.slice(-4); // Get last 4 windows
                
                if (lastFourWindows.length === 0) return;
                
                html += `
                    <div class="window-card">
                        <div class="window-title">חלון ${windowSize} ימים</div>
                `;
                
                lastFourWindows.forEach((result, index) => {
                    const deltaClass = getDeltaClass(result.delta);
                    const deltaText = formatDelta(result.delta);
                    const trendIndicator = getTrendIndicator(result.delta);
                    
                    html += `
                        <div class="window-item ${deltaClass}">
                            <div class="window-header">
                                <div class="window-number">חלון ${result.index}</div>
                                <div class="window-dates">
                                    ${result.range}
                                    <span class="window-days">${result.daysCount} ימים</span>
                                </div>
                            </div>
                            <div class="window-stats">
                                <div class="window-average">${formatWeight(result.average)} ק״ג</div>
                                <div class="window-delta ${deltaClass}">
                                    ${deltaText} ${trendIndicator}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add summary box for last 3 windows
                const summary = calculateWindowSummary(results);
                if (summary) {
                    const summaryDeltaClass = getDeltaClass(summary.avgDelta);
                    const summaryDeltaText = formatDelta(summary.avgDelta);
                    const summaryTrendIndicator = getTrendIndicator(summary.avgDelta);
                    
                    const avgChangePerDayClass = getDeltaClass(summary.avgChangePerDay);
                    const avgChangePerDayText = formatDelta(summary.avgChangePerDay);
                    const avgChangePerDayTrend = getTrendIndicator(summary.avgChangePerDay);
                    
                    const totalChangeClass = getDeltaClass(summary.totalChange);
                    const totalChangeText = formatDelta(summary.totalChange);
                    const totalChangeTrend = getTrendIndicator(summary.totalChange);
                    
                    html += `
                        <div class="window-summary">
                            <div class="summary-title">📊 סיכום ${summary.windowCount} חלונות אחרונים</div>
                            <div class="summary-stats">
                                <div class="summary-item">
                                    <div class="summary-value">${formatWeight(summary.avgWeight)}</div>
                                    <div class="summary-label">ממוצע משקל</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${summaryDeltaText} ${summaryTrendIndicator}</div>
                                    <div class="summary-label">ממוצע שינוי לחלון</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${avgChangePerDayText} ${avgChangePerDayTrend}</div>
                                    <div class="summary-label">ממוצע שינוי ליום</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${totalChangeText} ${totalChangeTrend}</div>
                                    <div class="summary-label">שינוי כולל</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${summary.totalDays}</div>
                                    <div class="summary-label">סה״כ ימים</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Load data from Google Sheets
        async function loadData() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const summary = document.getElementById('summary');
            
            loading.style.display = 'block';
            results.innerHTML = '';
            summary.style.display = 'none';
            
            try {
                console.log('טוען נתוני משקל מ-Google Sheets...');
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbxm9p0ckreQ88HAqR-DZ_blJqyEhtm2GCQy_gXtvHyjXZULMdMgdWWFaIaFXfT-4ZT6/exec?action=get');
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Convert data to the format we need
                    currentData = data.data.map(row => ({
                        date: row[0], // Date
                        weight: parseFloat(row[1]) // Weight
                    }));
                    
                    console.log(`נטענו ${currentData.length} נקודות נתונים`);
                    
                    // Calculate and display summary
                    const summaryStats = calculateSummary(currentData);
                    if (summaryStats) {
                        displaySummary(summaryStats);
                    }
                    
                    // Display results
                    displayResults(currentData);
                } else {
                    results.innerHTML = '<div class="no-data">לא נמצאו נתונים ב-Google Sheets</div>';
                }
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                results.innerHTML = '<div class="no-data">שגיאה בטעינת הנתונים</div>';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('דף סקירה מקיפה נטען');
        });
    </script>
</body>
</html>
